name: Validate

on:
  push:
    branches: ["main", "cicd"]
  pull_request:
    branches: ["main"]

jobs:

  validate-kustomize:
    runs-on: self-hosted
    container:
      image: harbor.squid-ink.us/politeauthority/polite-cicd:${{ vars.CICD_VERSION }}
      credentials:
        username: politeauthority
        password: ${{ secrets.HARBOR_PASSWORD }}
    steps:
      - uses: actions/checkout@v3
      - name: Validate Kustomize - Argo
        run: |
          kustomize build cluster/argocd -o argo.yaml
      - name: Validate Kustomize - Bedrock
        run: |
          kustomize build cluster/bedrock/cert-manager -o cert-manager.yaml
      - name: Validate Kustomize - Sandbox
        run: |
          kustomize build cluster/sandbox/github-runners -o github-runners.yaml

  validate-helm:
    runs-on: self-hosted
    container:
      image: harbor.squid-ink.us/politeauthority/polite-cicd:${{ vars.CICD_VERSION }}
      credentials:
        username: politeauthority
        password: ${{ secrets.HARBOR_PASSWORD }}
    strategy:
        fail-fast: true
    steps:
        - uses: actions/checkout@v3
        - name: Validate Helm - Bedrock
          run: |
            helm lint cluster/bedrock/ingress/ingress-private
            helm dependency build cluster/bedrock/ingress/ingress-private
            helm template cluster/bedrock/ingress/ingress-private -f cluster/bedrock/ingress/ingress-private/values-colfax.yaml --dry-run > out.yaml

            helm lint cluster/bedrock/ingress/ingress-public
            helm dependency build cluster/bedrock/ingress/ingress-private
            helm template cluster/bedrock/ingress/ingress-public -f cluster/bedrock/ingress/ingress-public/values-colfax.yaml --dry-run > out.yaml

            helm lint cluster/bedrock/loki
            helm dependency build cluster/bedrock/loki
            helm template cluster/bedrock/loki -f cluster/bedrock/loki/values-colfax.yaml --dry-run > out.yaml

            helm lint cluster/bedrock/monitoring/prometheus-stack
            helm dependency build cluster/bedrock/monitoring/prometheus-stack
            helm template cluster/bedrock/monitoring/prometheus-stack -f cluster/bedrock/monitoring/prometheus-stack/values-colfax.yaml --dry-run > out.yaml

            helm lint cluster/bedrock/storage/nfs-client
            helm dependency build cluster/bedrock/storage/nfs-client
            helm template cluster/bedrock/storage/nfs-client -f cluster/bedrock/storage/nfs-client/values-colfax.yaml --dry-run > out.yaml

        - name: Validate Helm - Sandbox
          run: |
            helm lint cluster/sandbox/graylog
            helm dependency build cluster/sandbox/graylog
            helm template cluster/sandbox/graylog -f cluster/sandbox/graylog/values-colfax.yaml --dry-run > out.yaml


            helm lint cluster/sandbox/harbor
            helm dependency build cluster/sandbox/harbor
            helm template cluster/sandbox/harbor -f cluster/sandbox/harbor/values-colfax.yaml --dry-run > out.yaml


  validate-yaml:
    runs-on: self-hosted
    container:
      image: harbor.squid-ink.us/politeauthority/polite-cicd:${{ vars.CICD_VERSION }}
      credentials:
        username: politeauthority
        password: ${{ secrets.HARBOR_PASSWORD }}
    strategy:
        fail-fast: true
    steps:
        - uses: actions/checkout@v3
        - name: Validate Yaml
          run: |
            yamllint -c config-yaml-lint.yaml ./ --no-warnings
